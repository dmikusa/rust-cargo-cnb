# Rust Cargo Install Cloud Native Buildpack

The Rust Cargo Install Buildpack is a Cloud Native Buildpack V3 that build Rust applications.

This buildpack is designed to work in collaboration with the [Rust Dist CNB](https://github.com/paketo-community/rust-dist) buildpacks which provides the actual Rust and Cargo binaries used by this buildpack.

## Usage

In general, [you probably want the rust CNB instead](https://github.com/paketo-community/rust/#tldr). If you want to use this particular CNB directly, the easiest way is via image.

Run `pack build -b paketo-community/cargo-install:<version> ...`. Alternatively, follow the instructions in the next section to build locally and `pack build -b cargo-install_xxxx` (folder generated by the build script). The latter is useful when developing.

## Detection

The detection phase passes if both of the following conditions hold true:

- `<APPLICATION_ROOT>/Cargo.toml` exists
- `<APPLICATION_ROOT>/Cargo.lock` exists

## Configuration

### BP_CARGO_INSTALL_ARGS

By default, the buildpack will run `cargo install --color=never --root=<destination layer> --path=.`, which will build the code and install a single binary. This works for a single project that exists at the root of the application project. It does not work if you have a workspace or multiple binaries in your project (unless you've set a default binary).

To be more flexible and allow building additional projects, you may use this environment variable to pass additional arguments to `cargo install`.

For example:

- `--path=./todo` to build a single member in a folder called `./todo` that is part of a workspace
- `--bins` to build all binaries in your project
- `--bin=foo` to specifically build the foo binary when multiple binaries are present
- `-v` to get more verbose output from `cargo install`
- `--frozen` or `--locked` or customizing how Cargo will use the Cargo.lock file
- `--offline` for preventing Cargo from trying to access the Internet
- or any other valid arguments that can be passed to `cargo install`

You may **not** set `--color` and you may not set `--root`. These are fixed by the buildpack in order to make output look correct and to ensure that binaries are installed into the proper location.

### BP_CARGO_WORKSPACE_MEMBERS

By default, when you build a workspace with multiple members the buildpack will build and install all members of the workspace. If you'd like to reduce this to only building a select set of members, you can do this by setting `BP_CARGO_WORKSPACE_MEMBERS` to a comma delimited list of workspace package names (this is the package name in the member's Cargo.toml, not what is in the workspace's Cargo.toml's member list).

This option may be used in conjunction with `BP_CARGO_INSTALL_ARGS`. In that case, the additional arguments set in `BP_CARGO_INSTALL_ARGS` to each invocation of `cargo install`. 

You may not set `--color` or `--root`, just like when using `BP_CARGO_INSTALL_ARGS` by itself. In addition, you may not set `--path` in `BP_CARGO_INSTALL_ARGS` when also setting `BP_CARGO_WORKSPACE_MEMBERS`, as this does not logically make sense. 

In summary:

- Use `BP_CARGO_INSTALL_ARGS` and `--path` to build one specific member of a workspace.
- Use `BP_CARGO_INSTALL_ARGS` to specify non-`--path` arguments to `cargo install`
- Use `BP_CARGO_WORKSPACE_MEMBERS` to specify one or more workspace members to build (using `BP_CARGO_WORKSPACE_MEMBERS` with only one member has identical behavior to `BP_CARGO_INSTALL_ARGS` and `--path`)
- Don't set either `BP_CARGO_INSTALL_ARGS` and `--path`, or `BP_CARGO_WORKSPACE_MEMBERS` and the buildpack will iterate through and build all of the members in workspace.

## Integration

The Rust Cargo Install CNB will execute `cargo install`, which builds and installs your code into a layer that is available at runtime. The build will only happen if there are changes to `Cargo.lock` since the last build, otherwise the previous build is reused.

## Building

To package this buildpack for consumption:

```bash
$ ./scripts/package.sh
```

This builds the buildpack's Go source using GOOS=linux by default. You can supply another value as the first argument to package.sh.
